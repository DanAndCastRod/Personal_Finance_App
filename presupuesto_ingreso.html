<!doctype html>
<html lang="en">
    <head>
        <title>Presupuesto form</title>
        <!-- Required meta tags -->
        <meta charset="utf-8" />
        <meta
            name="viewport"
            content="width=device-width, initial-scale=1, shrink-to-fit=no"
        />
        <link rel="shortcut icon" href="../img/ejecoom_icon-removebg-preview.ico" type="image/x-icon">

        <!-- Bootstrap CSS v5.2.1 -->
        <link rel="stylesheet" href="./styles/styles.css">
        <link rel="stylesheet" href="./styles/bootstrap.min.css">
        <link rel="stylesheet" href="./styles/bootstrap-icons.css">
        <link rel="stylesheet" href="./styles/fontawesome.min.css">
        <link rel="stylesheet" href="./styles/material-components-web.min.css">
        <link rel="stylesheet" href="./styles/icon.css">
        <link rel="stylesheet" href="./styles/pe7sicons.css">
        <link rel="stylesheet" href="./styles/all.min.css">
        <link rel="shortcut icon" href="./img/favicon-bios-new.ico" type="image/x-icon">
        <script type="module" src="https://cdn.jsdelivr.net/npm/ionicons/dist/ionicons/ionicons.esm.js"></script>
        <script nomodule src="https://cdn.jsdelivr.net/npm/ionicons/dist/ionicons/ionicons.js"></script>

    </head>
    <style>
        *{
            --sidebar-width: 250px;

        }
        main{}
        
    </style>
    <body>
        <div class="app-container app-theme-white">
            <header>
                <navbarGB></navbarGB>
            </header>
        

            <div class="app-main">
                <sidebarGB></sidebarGB>
                <div class="app-main__outer">

                <div class="container ">
                    <div class="pt-3 d-flex justify-content-between">
                        <div class="d-flex">
                            <a href="./presupuesto.html" class="align-content-center"><i class="pe-7s-angle-left mx-2" style="font-size: 40px;"></i></a>
                            <h2 >Añadir nuevo presupuesto</h2>
                        </div>
                        <div>
                            <button id="bnt_envio" class="btn btn-outline-success" onclick="send_data()">Enviar</a>
                        </div>
                    </div>
                    <div class="mt-3">
                        <div class="row">
                            <div class="col">
                                <label for="plazo" class="form-check-label">Periodicidad</label>
                                
                                <div class="btn-group" role="group" aria-label="Basic radio toggle button group" name="plazo" id="plazo" onchange="display_frequencias(this)">
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio0" autocomplete="off" checked>
                                    <label class=" btn btn-sm btn-outline-primary" for="btnradio0">Sin repeteción</label>

                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off">
                                    <label class=" btn btn-sm btn-outline-primary" for="btnradio1">Diaria</label>
                                
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
                                    <label class=" btn btn-sm btn-outline-primary" for="btnradio2">Semanal</label>
                                
                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio3" autocomplete="off">
                                    <label class=" btn btn-sm btn-outline-primary" for="btnradio3">Quincenal</label>

                                    <input type="radio" class="btn-check" name="btnradio" id="btnradio4" autocomplete="off">
                                    <label class=" btn btn-sm btn-outline-primary" for="btnradio4">Mensual</label>
                                </div>
                            </div>
                            <div class="col"></div>
                        </div>
                        <div class="row" id="frecuencia">
                            <div class="mt-3 col-md-4 d-none">
                                <label for="freq_sem" class="form-label">Frecuencia semanal</label>
                                <select name="freq_sem" id="freq_sem" class="form-control form-select">
                                    <option value=""></option>
                                    <option value="1">L</option>
                                    <option value="2">M</option>
                                    <option value="3">X</option>
                                    <option value="4">J</option>
                                    <option value="5">V</option>
                                    <option value="6">S</option>
                                    <option value="7">D</option>
                                </select>
                                <small id="helpId" class="form-text text-muted">Selecciona el día de la semana</small>
                            </div>
                            
                            <div class="mt-3 col-md-4 d-none">
                                <label for="freq_quin" class="form-label">Frecuencia Quincenal</label>
                                <select name="freq_quin" id="freq_quin" class="form-control form-select">
                                    <option value=""></option>
                                    <option value="1">Primera Quincena</option>
                                    <option value="2">Segunda Quincena</option>
                                </select>
                                <small id="helpId" class="form-text text-muted">Selecciona La Quincena </small>
                            </div>
                            <div class="mt-3 col-md-4 d-none">
                                <label for="freq_mes" class="form-label">Frecuencia Mensual</label>
                                <input name="freq_mes" id="freq_mes" class="form-control" list="listadias">
                                </input>
                                <datalist id="listadias">
                                    <option value=""></option>
                                    <option value="1">1</option>
                                    <option value="5">5</option>
                                    <option value="10">10</option>
                                    <option value="15">15</option>
                                    <option value="20">20</option>
                                    <option value="25">25</option>
                                    <option value="30">30</option>
                                </datalist>
                                <small id="helpId" class="form-text text-muted">Selecciona el día del mes </small>
                            </div>
                            <div class="mt-3 col"></div>

                        </div>

                        <div class="row" id="gastos">
                            
                        </div>
                        <div class="d-grid gap-2">
                            <button
                                type="button"
                                name="btn_add_gasto"
                                id="btn_add_gasto"
                                class="btn btn-outline-secondary btn-sm"
                                onclick="add_gasto()"
                            >
                                + añadir gasto
                            </button>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <drawerGB></drawerGB>
        <modals>
           <div
            class="modal fade"
            id="modalId"
            tabindex="-1"
            data-bs-backdrop="static"
            data-bs-keyboard="false"
            
            role="dialog"
            aria-labelledby="modalTitleId"
            aria-hidden="true"
           >
            <div
                class="modal-dialog   modal-sm"
                role="document"
            >
                <div class="modal-content">
                    <!-- <div class="modal-header">
                        <h5 class="modal-title" id="modalTitleId">
                            Modal title
                        </h5>
                        <button
                            type="button"
                            class="btn-close"
                            data-bs-dismiss="modal"
                            aria-label="Close"
                        ></button>
                    </div> -->
                    <div class="modal-body">
                        <div class="text-center justify-content-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="60" height="60" fill="var(--bs-success)" class="bi bi-check-circle-fill group-hover:animate-bounce" viewBox="0 0 16 16">
                                <path d="M16 8A8 8 0 1 1 0 8a8 8 0 0 1 16 0m-3.97-3.03a.75.75 0 0 0-1.08.022L7.477 9.417 5.384 7.323a.75.75 0 0 0-1.06 1.06L6.97 11.03a.75.75 0 0 0 1.079-.02l3.992-4.99a.75.75 0 0 0-.01-1.05z"/>
                            </svg>

                            <div class="mt-3">Enviado con Exito</div>
                        </div>
                    </div>
                    <div class="modal-footer">
                        <button
                            type="button"
                            class="btn btn-secondary"
                            data-bs-dismiss="modal"
                            onclick="window.location.href='./presupuesto.html'"
                        >
                            Cerrar
                        </button>
                        <!-- <button type="button" class="btn btn-primary">Save</button> -->
                    </div>
                </div>
            </div>
           </div>

        </modals>
        <!-- Bootstrap JavaScript Libraries -->

        <script src="./scripts/components.js"></script>
        <script src="./scripts/script.js"></script>
        <script src="./scripts/jquery.min.js"></script>
        <script src="./scripts/popper.min.js"></script>
        <script src="./scripts/bootstrap.min.js"></script>
        <script src="https://unpkg.com/feather-icons/dist/feather.min.js"></script>
        <script>
          feather.replace()
        </script>
        <script>
            edit = window.location.href.includes('id')
            if (edit){
                id = window.location.href.split('id=')[1]
                bnt_envio.innerText = 'Actualizar'
                fetch('https://app.ejecomercial.co:1880/get_edit_data/'+id)
                .then(response => response.json())
                .then(data_edit => {
                    registro = data_edit
                    plazo.querySelectorAll('input').forEach(e=>{
                        if(e.nextElementSibling.innerText.includes(registro.periodo)){
                            e.checked = true
                            console.log(e.id)
                            display_frequencias(e.parentElement)
                            frecuencia_cont = document.getElementById(frecuencia.querySelector('[class*=col-md-4]:not([class*=d-none])'))
                            if(frecuencia_cont!=null){
                                frecuencia_cont.querySelector('label').getAttribute('for').value = registro.frecuencia
                            }
                            registro.detalle.forEach(itm =>{
                                gastos.innerHTML += `
                                <div class="row mb-2 fila" id="fila_${itm.id_reg}">
                                            <div class="col">
                                                <label class="form-label"for="">Nombre </label>
                                                <input type="text" class="name form-control form-control" value="${itm.nombre}">
                                                <small class='form-text text-muted'>Ingrese o Seleccione el nombre del gasto</small>
                                            </div>
                                            <div class="col">
                                                <label class="form-label"for="">Valor </label>
                                                <input type="text" class="value form-control form-control" value="${itm.monto}">
                                                <small class='form-text text-muted'>Ingrese o seleccione el valor presupuestado</small>
                                            </div>
                                            <div class="col">
                                                <label class="form-label"for="">Categoría </label>
                                                <input type="text" class="cat form-control form-control" value="${itm.categoria}">
                                                <small class='form-text text-muted'>Ingrese o seleccione una categoría</small>
                                            </div>
                                            <div class="col-md-1 align-self-center" onclick="deleterow(this)" style="cursor:pointer;width:5px">x</div>
                                        </div>
                                `
                            })
                        }
                    })

                })

            }
            // showed = false
            // function showaside(){
            //     if(showed){
            //         sidebar.style.left = "-250px"
            //         button_aside.style.left = '0'

            //         showed = false
            //     }else{
            //         sidebar.style.left = "0"
            //         showed = true
            //         button_aside.style.left = 'var(--sidebar-width)'
            //     }


            // }
            // showaside()
            function create_id2() {
                // Generar un número aleatorio entre 1000000 y 9999999 para asegurar que tenga 7 dígitos
                const id = Math.floor(1000000 + Math.random() * 9000000);
                return id.toString();  // Convertimos el número a string en caso de necesitarlo como cadena
            }
            function display_frequencias(element){
                element.querySelectorAll('input').forEach(e=>{
                    if(e.checked){
                        switch(e.id){
                            case 'btnradio2':
                                frecuencia.querySelectorAll('.col-md-4').forEach(e=> e.classList.add('d-none'))
                                freq_sem.parentElement.classList.remove('d-none')
                                break
                            case 'btnradio3':
                                frecuencia.querySelectorAll('.col-md-4').forEach(e=> e.classList.add('d-none'))
                                freq_quin.parentElement.classList.remove('d-none')
                                break
                            case 'btnradio4':
                                frecuencia.querySelectorAll('.col-md-4').forEach(e=> e.classList.add('d-none'))
                                freq_mes.parentElement.classList.remove('d-none')
                                break
                            default:
                                frecuencia.querySelectorAll('.col-md-4').forEach(e=> e.classList.add('d-none'))
                                break

                        }
                    }
                })
            }
            function add_gasto(){
                gastos.innerHTML += `
                <div class="row mb-2" id="fila">
                            <div class="col">
                                <label class="form-label"for="">Nombre </label>
                                <input type="text" class="name form-control form-control">
                                <small class='form-text text-muted'>Ingrese o Seleccione el nombre del gasto</small>
                            </div>
                            <div class="col">
                                <label class="form-label"for="">Valor </label>
                                <input type="text" class="value form-control form-control">
                                <small class='form-text text-muted'>Ingrese o seleccione el valor presupuestado</small>
                            </div>
                            <div class="col">
                                <label class="form-label"for="">Categoría </label>
                                <input type="text" class="cat form-control form-control">
                                <small class='form-text text-muted'>Ingrese o seleccione una categoría</small>
                            </div>
                            <div class="col-md-1 align-self-center" onclick="deleterow(this)" style="cursor:pointer;width:5px">x</div>
                        </div>
                `
            }
            deletes = []
            function deleterow(element){
                element.parentElement.remove()
                if(edit){
                    deletes.push(element.parentElement.id)
                }
            }
            function display_modal(){
                modalElement = document.getElementById('modalId')
                modal = bootstrap.Modal.getOrCreateInstance(modalId)
                modal.show()
            }
            function send_data(){
                // Periodicidad y frecuencia
                var freq;
                var plz 
                plazo.querySelectorAll('input').forEach(e => {
                    if(e.checked){
                        plz= e.id.split('btnradio')[1]
                        switch(e.id){
                            case 'btnradio2':
                                freq = freq_sem.value
                                break
                            case 'btnradio3':
                                freq = freq_quin.value
                                break
                            case 'btnradio4':
                                freq = freq_mes.value
                                break
                            default:
                                freq = null
                                break

                        }
                    }
                })


                
                Data_send={
                    id_presupuesto:edit?id:create_id2(),
                    id_usuario:1088344174,
                    periodo: parseInt(plz)+1,
                    frecuencia: freq,
                    Registros:[]
                }
                if(edit){
                        document.querySelectorAll('.fila').forEach(e=>{
                            Data_send.Registros.push({nombre:e.querySelector('.name').value,monto:e.querySelector('.value').value,categoria:e.querySelector('.cat').value,id_reg:e.id.split('_')[1]})   
                        })
                        Data_send.nvos_Registros = []
                        document.querySelectorAll('#fila').forEach(e=>{
                            Data_send.nvos_Registros.push({nombre:e.querySelector('.name').value,monto:e.querySelector('.value').value,categoria:e.querySelector('.cat').value})   
                        })
                        Data_send.deletes = deletes
                        fetch('https://app.ejecomercial.co:1880/update_presupuesto/',{
                            method:'POST',
                            headers: {'Content-Type':'application/json'},
                            body: JSON.stringify(Data_send)
                        }).then(response=> response.text())
                        .then(response => {
                            if(response == 'OK'){
                                display_modal()
                            }
                        })
                    
                    }else{
                        document.querySelectorAll('#fila').forEach(e=>{
                            Data_send.Registros.push({nombre:e.querySelector('.name').value,monto:e.querySelector('.value').value,categoria:e.querySelector('.cat').value})   
                        })
                        fetch('https://app.ejecomercial.co:1880/post_presupuesto/',{
                            method:"POST",
                            headers: {'Content-Type':'application/json'},
                            body:JSON.stringify(Data_send)
                        }).then(response=> response.text())
                        .then(response=>{
                            display_modal()
                            // window.location.href='./presupuesto.html'
                        })
                    }


            }
            presupuesto_btn.classList.add('mm-active')
        </script>
        
    </body> 
</html>
